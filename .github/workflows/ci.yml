name: Continuous Integration

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:
    # Allows manual triggering

jobs:
  pylint:
    name: Code Quality (Pylint)
    runs-on: ubuntu-latest
    outputs:
      pylint-passed: ${{ steps.pylint-check.outputs.passed }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint setuptools
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Set up the environment properly
          echo "PYTHONPATH=.:$GITHUB_WORKSPACE" >> $GITHUB_ENV

      - name: Run Pylint Analysis
        id: pylint-check
        shell: bash
        run: |
          # Make sure there are Python files to analyze
          PYTHON_FILES=$(find ./src -name "*.py" | xargs)
          if [ -z "$PYTHON_FILES" ]; then
            echo "No Python files found to analyze! Check the paths and file structure."
            echo "passed=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "::group::Full Pylint Output"
          # Run pylint using the project's configuration file
          PYTHONPATH=src pylint --rcfile=.pylintrc $PYTHON_FILES || echo "Pylint check found issues"
          PYLINT_EXIT_CODE=$?
          echo "::endgroup::"

          # Extract disabled warnings from .pylintrc
          DISABLED_CHECKS=$(grep -oP '^disable=\K.*' .pylintrc || echo "")
          echo "Applying disabled warnings from .pylintrc: $DISABLED_CHECKS"

          echo "## ðŸ” Pylint Code Quality Results" >> $GITHUB_STEP_SUMMARY

          # Check for critical errors (error category) - fail if any are found
          echo "::group::Checking for Critical Errors"
          CRITICAL_ERRORS=$(PYTHONPATH=src pylint --rcfile=.pylintrc --disable=C,W,R,I --enable=E --msg-template="{path}:{line}:{column}: [{msg_id}({symbol}), {category}] {msg}" $PYTHON_FILES 2>&1 || echo "")

          # Check if there are actual errors (not just a perfect score message)
          if echo "$CRITICAL_ERRORS" | grep -E '\[[A-Z][0-9]+.*\(.*\), error\]' > /dev/null; then
            echo "âŒ Critical errors found:"
            echo "$CRITICAL_ERRORS"
            echo "### âŒ Critical Errors Found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$CRITICAL_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::error::Critical Python errors were found! These must be fixed before merging."
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… No critical errors found."
            echo "### âœ… No Critical Errors" >> $GITHUB_STEP_SUMMARY
            echo "passed=true" >> $GITHUB_OUTPUT
          fi
          echo "::endgroup::"

          # Check for warnings - report but don't fail
          echo "::group::Checking for Warnings"
          WARNINGS=$(PYTHONPATH=src pylint --rcfile=.pylintrc --disable=C,E,R,I --enable=W --msg-template="{path}:{line}:{column}: [{msg_id}({symbol}), {category}] {msg}" $PYTHON_FILES 2>&1 || echo "")

          if echo "$WARNINGS" | grep -E '\[[A-Z][0-9]+.*\(.*\), warning\]' > /dev/null; then
            echo "âš ï¸ Warnings found (non-blocking):"
            echo "$WARNINGS"
            echo "### âš ï¸ Warnings Found (Non-blocking)" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$WARNINGS" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No warnings found."
            echo "### âœ… No Warnings" >> $GITHUB_STEP_SUMMARY
          fi
          echo "::endgroup::"

          echo "Pylint analysis completed successfully."

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: pylint
    if: needs.pylint.outputs.pylint-passed == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: "requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Install any additional test dependencies if needed
          pip install setuptools

      - name: Run Unit Tests
        id: run-tests
        timeout-minutes: 3
        shell: bash
        run: |
          set +e  # Disable exit on error to handle errors gracefully

          echo "## ðŸ§ª Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ Timeout: 3 minutes (will fail if exceeded)" >> $GITHUB_STEP_SUMMARY

          # Change to project directory
          cd $GITHUB_WORKSPACE

          # Set up Python path to match local environment
          export PYTHONPATH="$GITHUB_WORKSPACE/src"

          echo "::group::Running Unit Tests"
          echo "About to run: python tests/run_unit_tests.py"
          echo "Current directory: $(pwd)"
          echo "PYTHONPATH: $PYTHONPATH"
          echo "Timeout: 3 minutes"

          # Run the unit tests using the project's test runner with timeout
          # Use stdbuf to force line buffering so we can see output in real-time
          timeout 180 stdbuf -oL -eL python tests/run_unit_tests.py 2>&1 | tee test_output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}

          echo "Test runner exit code: $TEST_EXIT_CODE"

          # Display the test output
          echo "Test output:"
          cat test_output.log

          echo "::endgroup::"

          # Check for timeout (exit code 124 from timeout command)
          if [ $TEST_EXIT_CODE -eq 124 ]; then
            echo "### â±ï¸ Test Execution Timeout!" >> $GITHUB_STEP_SUMMARY
            echo "Tests exceeded the 3-minute timeout limit." >> $GITHUB_STEP_SUMMARY
            echo "This indicates a hanging test or performance issue." >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 test_output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::error::Unit tests timed out after 3 minutes!"
            echo "test-passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Parse test results from the output
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            # Extract test summary from OVERALL SUMMARY section
            TOTAL_TESTS=$(grep "Total Tests Run:" test_output.log | grep -o "[0-9]\+" | head -1 || echo "0")
            PASSED_TESTS=$(grep "Passed:" test_output.log | tail -1 | grep -o "[0-9]\+" || echo "0")
            FAILED_TESTS=$(grep "Failed:" test_output.log | tail -1 | grep -o "[0-9]\+" || echo "0")

            echo "Extracted TOTAL_TESTS: '$TOTAL_TESTS'"
            echo "Extracted PASSED_TESTS: '$PASSED_TESTS'"
            echo "Extracted FAILED_TESTS: '$FAILED_TESTS'"

            if [ "$FAILED_TESTS" = "0" ] || [ -z "$FAILED_TESTS" ]; then
              echo "### âœ… All Tests Passed! ($PASSED_TESTS/$TOTAL_TESTS tests)" >> $GITHUB_STEP_SUMMARY
              echo "::notice::All $PASSED_TESTS unit tests passed successfully!"
              echo "test-passed=true" >> $GITHUB_OUTPUT
            else
              echo "### âŒ Some Tests Failed ($FAILED_TESTS failed, $PASSED_TESTS passed, $TOTAL_TESTS total)" >> $GITHUB_STEP_SUMMARY
              echo "::error::$FAILED_TESTS out of $TOTAL_TESTS unit tests failed!"
              echo "test-passed=false" >> $GITHUB_OUTPUT

              # Extract failed test details
              echo "#### Failed Test Details:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              grep -A 5 -B 5 "FAIL" test_output.log >> $GITHUB_STEP_SUMMARY || echo "Could not extract failure details" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY

              exit 1
            fi
          else
            echo "### âŒ Test Suite Failed to Run" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat test_output.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "::error::Unit test suite failed to execute properly (exit code: $TEST_EXIT_CODE)"
            echo "test-passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test_output.log
          retention-days: 30

  # Summary job that provides overall CI status
  ci-status:
    name: CI Status Summary
    runs-on: ubuntu-latest
    needs: [pylint, unit-tests]
    if: always()

    steps:
      - name: Determine CI Status
        run: |
          echo "## ðŸŽ¯ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY

          PYLINT_STATUS="${{ needs.pylint.result }}"
          TESTS_STATUS="${{ needs.unit-tests.result }}"

          echo "### Job Results:" >> $GITHUB_STEP_SUMMARY

          if [ "$PYLINT_STATUS" = "success" ]; then
            echo "- âœ… **Pylint**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Pylint**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$TESTS_STATUS" = "success" ]; then
            echo "- âœ… **Unit Tests**: Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$TESTS_STATUS" = "skipped" ]; then
            echo "- â­ï¸ **Unit Tests**: Skipped (Pylint failed)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ **Unit Tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Overall status
          if [ "$PYLINT_STATUS" = "success" ] && [ "$TESTS_STATUS" = "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŽ‰ **Overall Status: PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "All checks passed! This pull request is ready for review." >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âŒ **Overall Status: FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "Some checks failed. Please review and fix the issues before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
